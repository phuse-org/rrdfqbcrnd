---
title: "Usage of cube DEMO"
author: "mja@statgroup.dk"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    theme: united
  pdf_document:
    toc: true
    highlight: zenburn
  md_document:
    variant: markdown_github
---

# Introduction

This is not a good example yet - there is not real message nor flow in the document.
TODO(mja): fix it.

# Create DEMO sample table from CSV file

This script creates the result and codelist for a simple DEMO table.

```{r}
library(rrdfancillary)
devtools::load_all(pkg="../..")
```

```{r, eval=TRUE}

library(rrdfqbcrnd0)
library(rrdfqb)

cubeVocabularyFn<- system.file("extdata/cube-vocabulary-rdf","cube.ttl", package="rrdfqb")

dataCubeFile<- system.file("extdata/sample-rdf", "DC-DEMO-sample.ttl", package="rrdfqbcrndex")

store <- new.rdf()  # Initialize

cat("Loading cube specfication from ", cubeVocabularyFn, "\n")
tmp<- load.rdf(cubeVocabularyFn, format="TURTLE", appendTo= store)

cat("Loading cube from ", dataCubeFile, "\n")
tmp<- load.rdf(dataCubeFile, format="TURTLE", appendTo= store)

summarize.rdf(store)

```

## Execute the DEMO* SPARQL queries

```{r, eval=TRUE}

rqFiles<- system.file("extdata/sample-rdf", list.files(system.file("extdata/sample-rdf",  package="rrdfqbcrndex"), pattern="DEMO.+rq$"),  package="rrdfqbcrndex")

for (rqFile in rqFiles) {
    cat("File ", rqFile, "\n")
    rq<- paste0(readLines(rqFile),collapse="\n")
    res<- data.frame(sparql.rdf(store, rq),stringsAsFactors=FALSE)
    print(nrow(res))
    if (nrow(res)>0) {
        print(knitr::kable(res))
        }
}

```

## This works do not change

```{r, eval=TRUE}

dsdName<- GetDsdNameFromCube( store )
domainName<- GetDomainNameFromCube( store )
cat("dsdName ", dsdName, ", domainName ", domainName, "\n" )
forsparqlprefix<- GetForSparqlPrefix( domainName )
cat(forsparqlprefix,"\n")

rq<-  paste( forsparqlprefix,
'
select *
where { 
?s a qb:Observation ; 
?p ?o .
[] qb:dimension ?p .
values (?s) {
(ds:obs114)
}
}
# limit 30
',
"\n"                               
)

cube.observations<- sparql.rdf(store, rq)
knitr::kable(cube.observations)


```

## Getting triples with information of object if literal


```{r, eval=TRUE}
cons.rq<-  paste( forsparqlprefix,
'
construct { ?s ?p ?o }
where { 
?s ?p ?o .
BIND( datatype(?o) as ?datatype )
BIND( isLiteral(?o) as ?isLiteral )
BIND( lang(?o) as ?lang )
values (?s) {
(ds:obs114)
}
}
',
"\n"                               
)


save.rdf(construct.rdf( store, cons.rq) , file.path(tempdir(), "rapperin.ttl"), "TURTLE")
```

To see dot code generated by rapper:
```
rapper -i turtle -o dot /tmp/Rtmpcccgdg/rapperin.ttl
```

To display the dot code
```
rapper -i turtle -o dot /tmp/Rtmpcccgdg/rapperin.ttl | dot -x -Tpdf -ograph.pdf
```

See also (http://www.bioconductor.org/packages/release/bioc/vignettes/Rgraphviz/inst/doc/Rgraphviz.pdf) for Rgraphviz package - may be used to display graphs.

ToDo(MJA): move this to another package - is more an example of R code for making Rgraphvis statement

```{r, eval=FALSE}

rq<-  paste( forsparqlprefix,
'
select *
where { 
?s ?p ?o .
BIND( datatype(?o) as ?datatype )
BIND( isLiteral(?o) as ?isLiteral )
BIND( lang(?o) as ?lang )
values (?s) {
(ds:obs114)
}
}
',
"\n"                               
)


res<- sparql.rdf(store, rq)
knitr::kable(res)

dimnames(res)

allIRI<- c( res[,1],res[,2])
uallIRI<- unique(allIRI)
L<- list()
for (i in 1:length(uallIRI) ) {
L[[ uallIRI[i] ]] <- paste( "L", i, sep="" )
}


rowcols<- cbind( as.matrix(apply(res[,1:2],c(1,2),function(x) as.character(L[[x]] ))),as.matrix(res[,3]))
cat(paste(rowcols, sep=", "),"\n")

```

### Check the statistics

ToDo(MJA): move this to another package - maybe the check package

```{r, eval=FALSE}

stmtSQL<- GetSQLFromCube(store) 
cat(stmtSQL$summStatSQL) 

```
